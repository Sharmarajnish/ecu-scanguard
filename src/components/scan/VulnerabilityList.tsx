import { useState } from 'react';
import { ChevronDown, ChevronRight, ExternalLink, Code, AlertTriangle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { SeverityBadge } from '@/components/ui/severity-badge';
import { Badge } from '@/components/ui/badge';
import type { Vulnerability } from '@/hooks/useScans';
import { useUpdateVulnerabilityStatus } from '@/hooks/useScans';
import { cn } from '@/lib/utils';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
}

type VulnerabilityStatus = 'new' | 'reopened' | 'fixed' | 'false_positive' | 'risk_accepted';

const statusColors: Record<VulnerabilityStatus, string> = {
  new: 'bg-primary/20 text-primary border-primary/30',
  reopened: 'bg-warning/20 text-warning border-warning/30',
  fixed: 'bg-success/20 text-success border-success/30',
  false_positive: 'bg-muted text-muted-foreground border-muted-foreground/30',
  risk_accepted: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
};

export function VulnerabilityList({ vulnerabilities }: VulnerabilityListProps) {
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [filterSeverity, setFilterSeverity] = useState<string>('all');
  const updateStatus = useUpdateVulnerabilityStatus();

  const filteredVulns = vulnerabilities.filter(
    (v) => filterSeverity === 'all' || v.severity === filterSeverity
  );

  const handleUpdateStatus = (id: string, status: VulnerabilityStatus) => {
    updateStatus.mutate({ id, status });
  };

  return (
    <div className="glass-card rounded-xl border border-border">
      {/* Header */}
      <div className="p-5 border-b border-border flex items-center justify-between">
        <div className="flex items-center gap-2">
          <AlertTriangle className="w-5 h-5 text-warning" />
          <h3 className="text-lg font-semibold text-foreground">Vulnerabilities</h3>
          <Badge variant="secondary" className="ml-2">
            {vulnerabilities.length}
          </Badge>
        </div>
        
        <Select value={filterSeverity} onValueChange={setFilterSeverity}>
          <SelectTrigger className="w-[140px] bg-muted/50">
            <SelectValue placeholder="Filter" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Severities</SelectItem>
            <SelectItem value="critical">Critical</SelectItem>
            <SelectItem value="high">High</SelectItem>
            <SelectItem value="medium">Medium</SelectItem>
            <SelectItem value="low">Low</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Vulnerability List */}
      <div className="divide-y divide-border">
        {filteredVulns.map((vuln, index) => {
          const vulnStatus = (vuln.status || 'new') as VulnerabilityStatus;
          
          return (
            <Collapsible
              key={vuln.id}
              open={expandedId === vuln.id}
              onOpenChange={(open) => setExpandedId(open ? vuln.id : null)}
            >
              <CollapsibleTrigger asChild>
                <div 
                  className={cn(
                    "p-4 hover:bg-muted/30 cursor-pointer transition-colors animate-fade-in",
                  )}
                  style={{ animationDelay: `${index * 30}ms` }}
                >
                  <div className="flex items-start gap-4">
                    <Button variant="ghost" size="icon" className="shrink-0 h-6 w-6 mt-0.5">
                      {expandedId === vuln.id ? (
                        <ChevronDown className="w-4 h-4" />
                      ) : (
                        <ChevronRight className="w-4 h-4" />
                      )}
                    </Button>
                    
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1 flex-wrap">
                        <SeverityBadge severity={vuln.severity} />
                        {vuln.cve_id && (
                          <span className="text-xs font-mono text-primary">{vuln.cve_id}</span>
                        )}
                        {vuln.cwe_id && (
                          <span className="text-xs font-mono text-muted-foreground">{vuln.cwe_id}</span>
                        )}
                        <Badge 
                          variant="outline" 
                          className={cn("text-xs", statusColors[vulnStatus])}
                        >
                          {vulnStatus.replace('_', ' ')}
                        </Badge>
                      </div>
                      <h4 className="font-medium text-foreground">{vuln.title}</h4>
                      <p className="text-sm text-muted-foreground line-clamp-2 mt-1">
                        {vuln.description}
                      </p>
                    </div>

                    <div className="text-right shrink-0">
                      <div className="text-2xl font-bold text-foreground font-mono">
                        {vuln.cvss_score?.toFixed(1) || 'N/A'}
                      </div>
                      <div className="text-xs text-muted-foreground">CVSS</div>
                    </div>
                  </div>
                </div>
              </CollapsibleTrigger>

              <CollapsibleContent>
                <div className="px-4 pb-4 pl-14 space-y-4">
                  {/* Affected Component */}
                  <div className="flex items-center gap-4 text-sm flex-wrap">
                    {vuln.affected_component && (
                      <div>
                        <span className="text-muted-foreground">Component: </span>
                        <span className="font-mono text-foreground">{vuln.affected_component}</span>
                      </div>
                    )}
                    {vuln.affected_function && (
                      <div>
                        <span className="text-muted-foreground">Function: </span>
                        <span className="font-mono text-foreground">{vuln.affected_function}</span>
                      </div>
                    )}
                    {vuln.line_number && (
                      <div>
                        <span className="text-muted-foreground">Line: </span>
                        <span className="font-mono text-foreground">{vuln.line_number}</span>
                      </div>
                    )}
                    {vuln.detection_method && (
                      <div>
                        <span className="text-muted-foreground">Detection: </span>
                        <Badge variant="outline" className="text-xs">{vuln.detection_method}</Badge>
                      </div>
                    )}
                  </div>

                  {/* Attack Vector */}
                  {vuln.attack_vector && (
                    <div className="p-3 rounded-lg bg-destructive/5 border border-destructive/20">
                      <h5 className="text-sm font-medium text-destructive mb-1">Attack Vector</h5>
                      <p className="text-sm text-muted-foreground">{vuln.attack_vector}</p>
                    </div>
                  )}

                  {/* Impact */}
                  {vuln.impact && (
                    <div className="p-3 rounded-lg bg-warning/5 border border-warning/20">
                      <h5 className="text-sm font-medium text-warning mb-1">Impact</h5>
                      <p className="text-sm text-muted-foreground">{vuln.impact}</p>
                    </div>
                  )}

                  {/* Code Snippet */}
                  {vuln.code_snippet && (
                    <div className="rounded-lg overflow-hidden border border-border">
                      <div className="px-3 py-2 bg-muted/50 border-b border-border flex items-center gap-2">
                        <Code className="w-4 h-4 text-muted-foreground" />
                        <span className="text-xs font-medium text-muted-foreground">Affected Code</span>
                      </div>
                      <pre className="p-4 text-sm font-mono overflow-x-auto bg-background/50">
                        <code className="text-foreground">{vuln.code_snippet}</code>
                      </pre>
                    </div>
                  )}

                  {/* Remediation */}
                  {vuln.remediation && (
                    <div className="p-4 rounded-lg bg-success/5 border border-success/20">
                      <h5 className="text-sm font-medium text-success mb-2">Remediation</h5>
                      <p className="text-sm text-muted-foreground">{vuln.remediation}</p>
                    </div>
                  )}

                  {/* LLM Enrichment */}
                  {vuln.llm_enrichment && typeof vuln.llm_enrichment === 'object' && (
                    <div className="p-4 rounded-lg bg-primary/5 border border-primary/20">
                      <h5 className="text-sm font-medium text-primary mb-2">AI Analysis</h5>
                      {(vuln.llm_enrichment as any).detailed_explanation && (
                        <p className="text-sm text-muted-foreground mb-3">
                          {(vuln.llm_enrichment as any).detailed_explanation}
                        </p>
                      )}
                      {(vuln.llm_enrichment as any).step_by_step_remediation && (
                        <div className="mt-2">
                          <h6 className="text-xs font-medium text-primary mb-1">Steps to Fix:</h6>
                          <ol className="list-decimal list-inside text-sm text-muted-foreground space-y-1">
                            {((vuln.llm_enrichment as any).step_by_step_remediation as string[]).map((step, i) => (
                              <li key={i}>{step}</li>
                            ))}
                          </ol>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Actions */}
                  <div className="flex items-center gap-2 flex-wrap">
                    {vuln.cve_id && (
                      <Button 
                        variant="outline" 
                        size="sm" 
                        className="gap-2"
                        onClick={() => window.open(`https://nvd.nist.gov/vuln/detail/${vuln.cve_id}`, '_blank')}
                      >
                        <ExternalLink className="w-3 h-3" />
                        View in NVD
                      </Button>
                    )}
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => handleUpdateStatus(vuln.id, 'false_positive')}
                      disabled={updateStatus.isPending}
                    >
                      Mark as False Positive
                    </Button>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => handleUpdateStatus(vuln.id, 'risk_accepted')}
                      disabled={updateStatus.isPending}
                    >
                      Accept Risk
                    </Button>
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => handleUpdateStatus(vuln.id, 'fixed')}
                      disabled={updateStatus.isPending}
                    >
                      Mark as Fixed
                    </Button>
                  </div>
                </div>
              </CollapsibleContent>
            </Collapsible>
          );
        })}

        {filteredVulns.length === 0 && (
          <div className="p-8 text-center text-muted-foreground">
            No vulnerabilities found matching the filter criteria.
          </div>
        )}
      </div>
    </div>
  );
}
